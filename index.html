<!-- Create an HTML 5 scaffolding with external js and css -->
<html>
  <head>
    <meta charset="utf-8" />
    <title>Kepler's Laws Simulation</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/font.css" />
  </head>
  <body>
    <!-- Main Body -->
    <!-- Logo -->
    <div class="logo">
      <h2 style="padding: 0px; margin: 0px; font-size: 3em;">
        Kepler's Laws</br><span style="font-size: 0.8em;">Simulation</span>
      </h2>
      <p class="neuropol">
        <b>Pi Ko</b> and <b>Marwan Ibrahim</b><br>
        (pk2269@nyu.edu, msi9696@nyu.edu)
      </p>
    </div>
    <p class="neuropol" style="font-size: 0.9em;position:absolute;left:15px;bottom:10px;padding: 0px;margin: 0px;z-index:1000000005">
      <b>Introduction to <br>Computer Simulation</b>
    </p>
    <p class="neuropol" style="font-size: 0.9em;position:absolute;right:15px;text-align: right;bottom:10px;padding: 0px;margin: 0px;z-index:1000000005">
      Professor : Charles Peskin<br>
      Instrucctor : Claire Valva
    </p>
    <!-- Navbar -->
    <header>
      <div class="box"></div>
      <div class="curve">
        <div class="left"><div></div></div>
        <div class="center"></div>
        <div class="right"><div></div></div>
      </div>
    </header>

    <!-- div called three-renderer -->
    <div id="three-renderer"></div>

    <div class="btn-container">
      <div class="button ice">Kepler's 1<sup>st</sup> Law</div>
      <div class="button ice">Kepler's 2<sup>nd</sup> Law</div>
      <div class="button ice">Kepler's 3<sup>rd</sup> Law</div>
    </div>

    <footer>
      <div class="curve">
        <div class="left"><div></div></div>
        <div class="center"></div>
        <div class="right">
          <div></div>
          <div>
            <a href=""><i class="fab fa-facebook-f"></i></a>
            <a href=""><i class="fab fa-instagram"></i></a>
            <a href=""><i class="fab fa-twitter"></i></a>
            <a href=""><i class="fas fa-envelope"></i></a>
          </div>
        </div>
      </div>
      <div class="box"></div>
    </footer>
    <!-- Add jquery -->
    <script
      async
      src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"
    ></script>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.150.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.150.0/examples/jsm/"
        }
      }
    </script>
    <script src="js/easeljs-0.7.1.min.js"></script>
    <script src="js/TweenMax.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/utils.js"></script>

    <script type="module">
      // Import necessary modules
      import * as THREE from 'three'
      import Stats from 'three/addons/libs/stats.module.js'
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js'
      import { FBXLoader } from 'three/addons/loaders/FBXLoader.js'
      import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js'
      import { RenderPass } from 'three/addons/postprocessing/RenderPass.js'
      import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js'
      import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js'
      // Declare earth and sun
      let earthModel, sunModel
      // Declare gloabal variables for three.js
      let camera, scene, renderer, stats, composer
      // Declare clock
      const clock = new THREE.Clock()
      // Bloom effect for more beautiful graphics, the following declare bloom parameters
      let mixer
      const params = {
        exposure: 1,
        bloomStrength: 0.5,
        bloomThreshold: 0,
        bloomRadius: 0.2,
      }

      // The following are utility/helper functions

      function onWindowResize() {
        // this function is called when the window is resized
        // This is to keep things at the center
        camera.aspect = window.innerWidth / window.innerHeight
        camera.updateProjectionMatrix()
        renderer.setSize(window.innerWidth, window.innerHeight)
        composer.setSize(window.innerWidth, window.innerHeight);
      }

      function addTrail(x,z){
        // Create a red sphere at the position x and z of earthModel
        const geometry = new THREE.SphereGeometry( 0.5, 32, 32 );
        const material = new THREE.MeshBasicMaterial( {color: 0xff0000} );
        const sphere = new THREE.Mesh( geometry, material );
        scene.add( sphere );
        sphere.position.x = x;
        sphere.position.z = z;
        sphere.position.y = 0;
        // Automatically destroy the sphere after 3 seconds
        setTimeout(function(){ scene.remove(sphere); }, 20000);
      }
      // This function sets up the necessary 3D graphics and rendering settings
      function setUpGraphics(){
        // Create a div container for three.js
        const container = document.createElement('div')
        // Append the container to the div called three-renderer
        document.body.appendChild(container)
        // Create a camera
        camera = new THREE.PerspectiveCamera(
          45,
          window.innerWidth / window.innerHeight,
          1,
          2000,
        )
        // Set the camera position
        camera.position.set(50, 800, 1000)
        // Create a scene
        scene = new THREE.Scene()
        // Set the background color
        scene.background = new THREE.Color(0x050505)
        // Create a renderer
        renderer = new THREE.WebGLRenderer({ antialias: true })
        renderer.setPixelRatio(window.devicePixelRatio)
        renderer.setSize(window.innerWidth, window.innerHeight)
        renderer.shadowMap.enabled = true
        container.appendChild(renderer.domElement)
        // Add a light
        const hemiLight = new THREE.HemisphereLight(0x111111, 0xa0a0a0, 0.9)
        hemiLight.position.set(0, 200, 0)
        scene.add(hemiLight)
        // Add another directional light
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.0)
        dirLight.position.set(0, 200, 100)
        dirLight.castShadow = true
        dirLight.shadow.camera.top = 180
        dirLight.shadow.camera.bottom = -100
        dirLight.shadow.camera.left = -120
        dirLight.shadow.camera.right = 120
        scene.add(dirLight)
        // Create the ground
        const mesh = new THREE.Mesh(
          new THREE.PlaneGeometry(100000000000, 100000000000),
          new THREE.MeshPhongMaterial({ color: 0x999999, depthWrite: false }),
        )
        mesh.rotation.x = -Math.PI / 2
        mesh.receiveShadow = true
        scene.add(mesh)
        // Create the grid
        const grid = new THREE.GridHelper(1000000, 10000, 0xffffff, 0xffffff)
        grid.material.opacity = 0.2
        grid.material.transparent = true
        scene.add(grid)
        // Add Glow/Bloom effect
        const renderScene = new RenderPass( scene, camera );
				const bloomPass = new UnrealBloomPass( new THREE.Vector2( window.innerWidth, window.innerHeight ), 1.5, 0.4, 0.85 );
				bloomPass.threshold = params.bloomThreshold;
				bloomPass.strength = params.bloomStrength;
				bloomPass.radius = params.bloomRadius;
				composer = new EffectComposer( renderer );
				composer.addPass( renderScene );
				composer.addPass( bloomPass );
        // Load the Earth model and textures
        const textureEarth = new THREE.TextureLoader().load(
          'textures/2_no_clouds_4k.jpg',
        )
        const materialEarth = new THREE.MeshPhongMaterial({ map: textureEarth })
        const geometry = new THREE.SphereGeometry(5, 32, 16)
        const sphere = new THREE.Mesh(geometry, materialEarth)
        earthModel = sphere
        scene.add(sphere)
        // Load the sun model and textures
        const textureSun = new THREE.TextureLoader().load('textures/sun.jpg')
        const materialSun = new THREE.MeshPhongMaterial({ map: textureSun })
        const geometrySun = new THREE.SphereGeometry(20, 32, 16)
        const sphereSun = new THREE.Mesh(geometrySun, materialSun)
        sunModel = sphereSun
        scene.add(sphereSun)
        sunModel.position.set(100, 100, 100)
        const controls = new OrbitControls(camera, renderer.domElement)
        controls.enableRotate =false;
        controls.minPolarAngle = Math.PI * 0.3
        controls.target.set(0, 100, 0)
        controls.update()
        window.addEventListener('resize', onWindowResize)
        // stats
        stats = new Stats()
        container.appendChild(stats.dom)
      }

      // This function is called every frame to update the graphics
      function setUpGraphicsAnimate(){
        requestAnimationFrame(animate)
        // create a timestep
        const delta = clock.getDelta()
        // Other helper functions for 3D graphics
        if (mixer) mixer.update(delta)
        renderer.render(scene, camera)
      }

        // This function is called every frame to display the graphics
      function renderGraphics(){
        stats.update()
        composer.render();
      }

      // Main function, initialization and animation loop
      init()
      animate()
      // Initialization function
      function init() {
        // Set up the graphics
        setUpGraphics() 
      }

      function animate() {
        setUpGraphicsAnimate();
        // Here we write the main code for simulation using timesteps
        earthModel.rotation.y += 0.2
        const scale = 100;
        sunModel.position.x = scale*4;
        sunModel.position.y = scale*0;
        sunModel.position.z = scale*0;
        // Measure the distance between the sun and the earth
        var distance = Math.sqrt(Math.pow(earthModel.position.x - sunModel.position.x, 2) + Math.pow(earthModel.position.z - sunModel.position.z, 2));
        var speed = 0.1;
        // NOrmalize speed between 0 and 0.1
        earthModel.position.x = scale*5*Math.cos(speed*3.141592*clock.getElapsedTime());
        earthModel.position.z = scale*3*Math.sin(speed*3.141592*clock.getElapsedTime());
        // Add a trail to the earth
        addTrail(earthModel.position.x, earthModel.position.z);
        // Render the graphics
        renderGraphics()
      }
    </script>
  </body>
</html>
